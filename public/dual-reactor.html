<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Alive Dual Reactor System</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: transparent;
  overflow: hidden;
}
.container {
  width: 520px;
  height: 220px;
  display: flex;
  gap: 24px;
  align-items: center;
  justify-content: center;
}
canvas {
  background: transparent;
  display: block;
}
</style>
</head>

<body>
<div class="container">
  <canvas id="weekly" width="240" height="220"></canvas>
  <canvas id="monthly" width="240" height="220"></canvas>
</div>

<script>
const API = "https://trading-dashboard-api-five.vercel.app/api/engine-ui";
let data = null;

/* ================= FETCH ================= */
async function fetchData() {
  try {
    const r = await fetch(API + "?t=" + Date.now(), { cache: "no-store" });
    data = await r.json();
  } catch {}
}
fetchData();
setInterval(fetchData, 10000);

const clamp = v => Math.max(0, Math.min(1, v));

function resolveState(d) {
  if (!d.hasTrades) return "IDLE";
  if (d.pl < 0) return "WARNING";
  if (d.pl === 0) return "BREAKEVEN";
  return "HEALTHY";
}

/* ================= REACTOR ================= */
function Reactor(canvas, baseColor, warningColor) {
  const ctx = canvas.getContext("2d");
  const C = { x: canvas.width / 2, y: canvas.height / 2 };
  const R = 64;
  const IR = 50;

  let wave = 0;
  let pulse = 0;
  let coreBreath = 0;
  let shimmerSeed = Math.random() * 1000;

  /* ---- DELTA TIME ---- */
  let lastTime = performance.now();

  /* ---- BURST BUBBLES ---- */
  const bursts = [];
  let lastBurst = performance.now();

  function spawnBurst(surfaceY) {
    const count = 4 + Math.floor(Math.random() * 2);
    for (let i = 0; i < count; i++) {
      bursts.push({
        x: (Math.random() * 2 - 1) * IR * 0.35,
        y: surfaceY,
        r: 1.6 + Math.random() * 0.4,
        vy: 0.45 + Math.random() * 0.25,
        life: 1
      });
    }
  }

  return function render(stats) {
    /* ---- DELTA NORMALIZATION ---- */
    const now = performance.now();
    const dt = Math.min(2, (now - lastTime) / 16.67); // clamp spikes
    lastTime = now;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const state = resolveState(stats);
    const progress = clamp(stats.progress || 0);

    /* -------- INNER CORE -------- */
    coreBreath += 0.07 * dt;
    const innerGlow = 14 + Math.sin(coreBreath) * 10;

    const coreGrad = ctx.createRadialGradient(
      C.x, C.y, 10,
      C.x, C.y, IR
    );
    coreGrad.addColorStop(0, "rgba(255,255,255,0.12)");
    coreGrad.addColorStop(1, "rgba(0,0,0,0.55)");

    ctx.save();
    ctx.beginPath();
    ctx.arc(C.x, C.y, IR, 0, Math.PI * 2);
    ctx.fillStyle = coreGrad;
    ctx.shadowColor = baseColor;
    ctx.shadowBlur = innerGlow;
    ctx.fill();
    ctx.restore();

    /* -------- NOISE SHIMMER -------- */
    shimmerSeed += 0.015 * dt;
    ctx.save();
    ctx.beginPath();
    ctx.arc(C.x, C.y, IR - 2, 0, Math.PI * 2);
    ctx.clip();

    for (let i = 0; i < 110; i++) {
      const a = Math.random() * Math.PI * 2;
      const r = Math.random() * IR;
      const flicker = (Math.sin(shimmerSeed + r * 0.08) + 1) * 0.5;

      ctx.fillStyle = `rgba(255,255,255,${0.012 * flicker})`;
      ctx.fillRect(
        C.x + Math.cos(a) * r,
        C.y + Math.sin(a) * r,
        1.1,
        1.1
      );
    }
    ctx.restore();

    /* -------- RING -------- */
    pulse += 0.115 * dt;
    const breathing = 30 + Math.sin(pulse) * 16;

    let ringColor = baseColor;
    if (state === "WARNING") ringColor = warningColor;
    if (state === "IDLE" || state === "BREAKEVEN") {
      ringColor = "rgba(170,170,170,0.95)";
    }

    ctx.save();
    ctx.beginPath();
    ctx.arc(C.x, C.y, R, 0, Math.PI * 2);
    ctx.strokeStyle = ringColor;
    ctx.lineWidth = 7.5;
    ctx.shadowColor = ringColor;
    ctx.shadowBlur = breathing;
    ctx.stroke();
    ctx.restore();

    /* -------- RING SHIMMER -------- */
    if (state === "HEALTHY" && Math.random() < 0.45 * dt) {
      const angle = Math.random() * Math.PI * 2;
      ctx.beginPath();
      ctx.arc(
        C.x,
        C.y,
        R,
        angle,
        angle + Math.PI * (0.035 + Math.random() * 0.02)
      );
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 1.6;
      ctx.stroke();
    }

    /* -------- FUEL -------- */
    if (state === "HEALTHY" && progress > 0) {
      wave += 0.062 * dt;

      const h = IR * 2 * progress;
      const baseY = C.y + IR;
      const topY = baseY - h;

      ctx.save();
      ctx.beginPath();
      ctx.arc(C.x, C.y, IR, 0, Math.PI * 2);
      ctx.clip();

      ctx.beginPath();
      for (let x = -IR; x <= IR; x++) {
        const w1 = Math.sin(x * 0.08 + wave) * 3.2;
        const w2 = Math.sin(x * 0.14 + wave * 1.6) * 2.4;
        ctx.lineTo(C.x + x, topY + w1 + w2);
      }
      ctx.lineTo(C.x + IR, baseY);
      ctx.lineTo(C.x - IR, baseY);
      ctx.closePath();

      const fuelGrad = ctx.createLinearGradient(0, topY, 0, baseY);
      fuelGrad.addColorStop(0, "rgba(210,255,240,0.95)");
      fuelGrad.addColorStop(1, baseColor);

      ctx.fillStyle = fuelGrad;
      ctx.shadowColor = baseColor;
      ctx.shadowBlur = 16;
      ctx.fill();
      ctx.restore();

      /* ---- BURST BUBBLES ---- */
      if (now - lastBurst > 6000 + Math.random() * 6000) {
        lastBurst = now;
        spawnBurst(topY);
      }

      for (let i = bursts.length - 1; i >= 0; i--) {
        const b = bursts[i];
        b.y -= b.vy * dt;
        b.life -= 0.018 * dt;

        if (b.life <= 0) {
          bursts.splice(i, 1);
          continue;
        }

        ctx.globalAlpha = Math.max(0, b.life * 0.5);
        ctx.beginPath();
        ctx.arc(C.x + b.x, b.y, b.r * b.life, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(200,255,240,1)";
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }
  };
}

/* ================= INIT ================= */
const weekly = Reactor(
  document.getElementById("weekly"),
  "rgba(90,200,150,0.95)",
  "rgba(140,90,90,0.95)"
);

const monthly = Reactor(
  document.getElementById("monthly"),
  "rgba(90,200,150,0.95)",
  "rgba(140,90,90,0.95)"
);

/* ================= LOOP ================= */
function loop() {
  if (data) {
    weekly(data.weekly);
    monthly(data.monthly);
  }
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>