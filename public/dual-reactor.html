<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Dual Reactor Status</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: transparent;
  overflow: hidden;
}

.wrapper {
  width: 520px;
  height: 220px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 20px;
}

canvas {
  background: transparent;
}
</style>
</head>

<body>

<div class="wrapper">
  <canvas id="weekly" width="220" height="220"></canvas>
  <canvas id="monthly" width="220" height="220"></canvas>
</div>

<script>
/* ================= CONFIG ================= */

const API_URL = "https://trading-dashboard-api-five.vercel.app/api/engine-ui";

const RADIUS = 66;
const INNER_RADIUS = 52;

/* ================= STATE ================= */

let weeklyData = null;
let monthlyData = null;

/* ================= CANVAS SETUP ================= */

function setup(canvas) {
  return {
    canvas,
    ctx: canvas.getContext("2d", { alpha: true }),
    center: { x: canvas.width / 2, y: canvas.height / 2 },
    wave: 0,
    breathe: 0
  };
}

const weekly = setup(document.getElementById("weekly"));
const monthly = setup(document.getElementById("monthly"));

/* ================= FETCH (STATE ONLY) ================= */

async function fetchData() {
  try {
    const res = await fetch(API_URL, { cache: "no-store" });
    const json = await res.json();
    weeklyData = json.weekly;
    monthlyData = json.monthly;
  } catch {}
}

fetchData();
setInterval(fetchData, 10000);

/* ================= HELPERS ================= */

function clamp(v) {
  return Math.max(0, Math.min(1, v));
}

function getProgress(d) {
  if (!d || !d.hasTrades || !d.target || d.target <= 0) return 0;
  return clamp(d.pl / d.target);
}

function getState(d) {
  if (!d || !d.hasTrades) return "IDLE";
  if (d.pl < 0) return "WARNING";
  return d.pl === 0 ? "BREAKEVEN" : "HEALTHY";
}

/* ================= COLORS ================= */

function palette(type, state) {
  if (type === "weekly") {
    return {
      base: "rgba(120,255,220,1)",
      glow: state === "IDLE" ? "rgba(120,255,220,0.25)" : "rgba(120,255,220,0.9)"
    };
  }
  return {
    base: "rgba(90,220,160,1)",
    glow: state === "IDLE" ? "rgba(90,220,160,0.25)" : "rgba(90,220,160,0.9)"
  };
}

/* ================= DRAWING ================= */

function drawRing(r, colors) {
  const { ctx, center } = r;

  r.breathe += 0.015;
  const glow = 26 + Math.sin(r.breathe) * 6;

  ctx.beginPath();
  ctx.arc(center.x, center.y, RADIUS, 0, Math.PI * 2);
  ctx.strokeStyle = colors.base;
  ctx.lineWidth = 8;
  ctx.shadowColor = colors.glow;
  ctx.shadowBlur = glow;
  ctx.stroke();
}

function drawDepth(r) {
  const { ctx, center } = r;

  const g = ctx.createRadialGradient(
    center.x, center.y, INNER_RADIUS * 0.3,
    center.x, center.y, INNER_RADIUS
  );
  g.addColorStop(0, "rgba(255,255,255,0.05)");
  g.addColorStop(1, "rgba(0,0,0,0.35)");

  ctx.beginPath();
  ctx.arc(center.x, center.y, INNER_RADIUS, 0, Math.PI * 2);
  ctx.fillStyle = g;
  ctx.fill();
}

function drawFuel(r, level, color, speed) {
  if (level <= 0) return;

  const { ctx, center } = r;
  r.wave += speed;

  const baseY = center.y + INNER_RADIUS;
  const h = INNER_RADIUS * 2 * level;
  const surface = baseY - h;

  ctx.save();
  ctx.beginPath();
  ctx.arc(center.x, center.y, INNER_RADIUS, 0, Math.PI * 2);
  ctx.clip();

  ctx.beginPath();
  ctx.moveTo(center.x - INNER_RADIUS, surface);
  for (let x = -INNER_RADIUS; x <= INNER_RADIUS; x++) {
    const y = Math.sin((x + r.wave) * 0.045) * 3;
    ctx.lineTo(center.x + x, surface + y);
  }
  ctx.lineTo(center.x + INNER_RADIUS, baseY);
  ctx.lineTo(center.x - INNER_RADIUS, baseY);
  ctx.closePath();

  const grad = ctx.createLinearGradient(0, surface, 0, baseY);
  grad.addColorStop(0, "rgba(200,255,235,0.95)");
  grad.addColorStop(1, color);

  ctx.fillStyle = grad;
  ctx.shadowColor = color;
  ctx.shadowBlur = 12;
  ctx.fill();

  ctx.restore();
}

/* ================= MAIN LOOP (ONE ONLY) ================= */

function render() {
  weekly.ctx.clearRect(0,0,220,220);
  monthly.ctx.clearRect(0,0,220,220);

  if (weeklyData) {
    const state = getState(weeklyData);
    const colors = palette("weekly", state);
    drawDepth(weekly);
    drawRing(weekly, colors);
    drawFuel(weekly, getProgress(weeklyData), colors.base, 0.35);
  }

  if (monthlyData) {
    const state = getState(monthlyData);
    const colors = palette("monthly", state);
    drawDepth(monthly);
    drawRing(monthly, colors);
    drawFuel(monthly, getProgress(monthlyData), colors.base, 0.2);
  }

  requestAnimationFrame(render);
}

render(); // ðŸ”’ SINGLE LOOP
</script>

</body>
</html>
