<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Dual Reactor Control</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: transparent;
  overflow: hidden;
}
.container {
  width: 520px;
  height: 220px;
  display: flex;
  gap: 24px;
  align-items: center;
  justify-content: center;
}
canvas { background: transparent; }
</style>
</head>

<body>
<div class="container">
  <canvas id="weekly" width="240" height="220"></canvas>
  <canvas id="monthly" width="240" height="220"></canvas>
</div>

<script>
const API = "https://trading-dashboard-api-five.vercel.app/api/engine-ui";
const canvases = {
  weekly: document.getElementById("weekly"),
  monthly: document.getElementById("monthly")
};

let data = null;
let lastFetch = 0;

async function fetchData() {
  try {
    const r = await fetch(API + "?t=" + Date.now(), { cache: "no-store" });
    data = await r.json();
  } catch {}
}
fetchData();
setInterval(fetchData, 10000);

/* ================= HELPERS ================= */

function clamp(v) { return Math.max(0, Math.min(1, v)); }

function resolveState(d) {
  if (!d.hasTrades) return "IDLE";
  if (d.pl < 0) return "WARNING";
  if (d.pl === 0) return "BREAKEVEN";
  return "HEALTHY";
}

/* ================= REACTOR ================= */

function Reactor(canvas, baseColor, warningColor, speedFactor) {
  const ctx = canvas.getContext("2d");
  const C = { x: canvas.width/2, y: canvas.height/2 };
  const R = 64;
  const IR = 50;

  let glow = 0;
  let wave = 0;
  let innerPulse = 0;

  return function render(stats) {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const state = resolveState(stats);
    const progress = clamp(stats.progress || 0);

    // INNER CORE (always breathing)
    innerPulse += 0.02;
    const coreGlow = 8 + Math.sin(innerPulse) * 4;
    const g = ctx.createRadialGradient(C.x, C.y, 10, C.x, C.y, IR);
    g.addColorStop(0, "rgba(255,255,255,0.08)");
    g.addColorStop(1, "rgba(0,0,0,0.4)");
    ctx.beginPath();
    ctx.arc(C.x, C.y, IR, 0, Math.PI*2);
    ctx.fillStyle = g;
    ctx.shadowColor = baseColor;
    ctx.shadowBlur = coreGlow;
    ctx.fill();

    // RING
    glow += state === "HEALTHY" ? 0.05*speedFactor : 0.02;
    ctx.beginPath();
    ctx.arc(C.x, C.y, R, 0, Math.PI*2);
    ctx.lineWidth = 8;

    let ringColor = baseColor;
    if (state === "WARNING") ringColor = warningColor;
    if (state === "IDLE") ringColor = "rgba(170,170,170,0.9)";

    ctx.strokeStyle = ringColor;
    ctx.shadowColor = ringColor;
    ctx.shadowBlur = state === "HEALTHY" ? 28 : 12;
    ctx.stroke();

    // FUEL
    if (state === "HEALTHY" && progress > 0) {
      wave += 0.04 * speedFactor;
      const h = IR*2*progress;
      const baseY = C.y + IR;
      const topY = baseY - h;

      ctx.save();
      ctx.beginPath();
      ctx.arc(C.x, C.y, IR, 0, Math.PI*2);
      ctx.clip();

      ctx.beginPath();
      for (let x=-IR;x<=IR;x++) {
        const w1 = Math.sin(x*0.06 + wave)*3;
        const w2 = Math.sin(x*0.12 + wave*1.7)*2;
        ctx.lineTo(C.x+x, topY + w1 + w2);
      }
      ctx.lineTo(C.x+IR, baseY);
      ctx.lineTo(C.x-IR, baseY);
      ctx.closePath();

      const fg = ctx.createLinearGradient(0,topY,0,baseY);
      fg.addColorStop(0,"rgba(220,255,245,0.95)");
      fg.addColorStop(1,baseColor);
      ctx.fillStyle = fg;
      ctx.shadowBlur = 12;
      ctx.shadowColor = baseColor;
      ctx.fill();
      ctx.restore();
    }
  }
}

/* ================= INIT ================= */

const weeklyReactor = Reactor(
  canvases.weekly,
  "rgba(120,255,220,0.9)",
  "rgba(160,60,60,0.9)",
  1.2
);

const monthlyReactor = Reactor(
  canvases.monthly,
  "rgba(90,200,150,0.9)",
  "rgba(160,60,60,0.9)",
  0.7
);

function loop() {
  if (data) {
    weeklyReactor(data.weekly);
    monthlyReactor(data.monthly);
  }
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
