<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Discipline Clock</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: transparent;
}

/* SAFETY ZONE */
.safe-zone {
  width: 320px;
  height: 320px;
  padding: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: visible;
  box-sizing: border-box;
}

/* CLOCK BASE */
.clock {
  position: relative;
  width: 200px;
  height: 200px;
  border-radius: 50%;
  background: transparent;
  overflow: visible;
}

/* RADIAL HALO — PERFECTLY EVEN */
.clock::after {
  content: "";
  position: absolute;
  inset: -40px;
  border-radius: 50%;
  background: radial-gradient(
    circle,
    rgba(120,255,200,0.45) 0%,
    rgba(120,255,200,0.30) 35%,
    rgba(120,255,200,0.15) 55%,
    rgba(120,255,200,0.05) 65%,
    transparent 72%
  );
  pointer-events: none;
  transition: background 0.6s ease;
}

/* INNER DEPTH */
.clock::before {
  content: "";
  position: absolute;
  inset: 6px;
  border-radius: 50%;
  box-shadow: inset 0 0 28px rgba(0,0,0,0.75);
  pointer-events: none;
}

/* MARKERS */
.marker {
  position: absolute;
  width: 3px;
  height: 12px;
  background: rgba(170, 230, 210, 0.95);
  top: 12px;
  left: 50%;
  transform-origin: center 88px;
}

/* HANDS */
.hand {
  position: absolute;
  top: 50%;
  left: 50%;
  transform-origin: 0% 50%;
  border-radius: 4px;
}

/* HOUR — MONTH PROGRESS */
.hour {
  width: 28%;
  height: 5px;
  background: rgba(220,255,240,1);
  box-shadow: 0 0 16px rgba(140,255,200,1);
}

/* MINUTE */
.minute {
  width: 42%;
  height: 3px;
  background: rgba(200,245,230,0.98);
  box-shadow: 0 0 14px rgba(140,255,200,0.85);
}

/* SECOND */
.second {
  width: 46%;
  height: 2px;
  background: rgb(255,80,80);
  box-shadow:
    0 0 26px rgba(255,80,80,1),
    0 0 16px rgba(255,150,150,0.9);
}

/* CENTER */
.center-dot {
  position: absolute;
  width: 8px;
  height: 8px;
  background: rgba(220,255,240,1);
  border-radius: 50%;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  box-shadow: 0 0 16px rgba(140,255,200,1);
}
</style>
</head>

<body>

<div class="safe-zone">
  <div class="clock" id="clock">
    <script>
      for (let i = 0; i < 12; i++) {
        document.write(
          `<div class="marker" style="transform: rotate(${i * 30}deg)"></div>`
        );
      }
    </script>

    <div class="hand hour" id="hour"></div>
    <div class="hand minute" id="minute"></div>
    <div class="hand second" id="second"></div>
    <div class="center-dot"></div>
  </div>
</div>

<script>
const clock = document.getElementById("clock");
const hourHand = document.getElementById("hour");
const minuteHand = document.getElementById("minute");
const secondHand = document.getElementById("second");

/* RESTORE STATE */
const savedVisual = JSON.parse(localStorage.getItem("clockVisual") || "{}");
if (savedVisual.halo) clock.style.setProperty("--halo", savedVisual.halo);

const savedAngles = JSON.parse(localStorage.getItem("clockAngles") || "{}");
if (savedAngles.h !== undefined) {
  hourHand.style.transform = `rotate(${savedAngles.h}deg)`;
  minuteHand.style.transform = `rotate(${savedAngles.m}deg)`;
  secondHand.style.transform = `rotate(${savedAngles.s}deg)`;
}

/* MONTH PROGRESS */
function getMonthProgressAngle() {
  const now = new Date();
  const day = now.getDate();
  const days = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
  return (day / days) * 360 - 90;
}

/* APPLY P&L HALO */
async function applyMonthlyState() {
  try {
    const res = await fetch("/api/engine?t=" + Date.now());
    const data = await res.json();
    const pl = data.monthly.pl;

    let halo;

    if (pl > 0) {
      /* EMERALD */
      halo = `
        radial-gradient(
          circle,
          rgba(120,255,200,0.55) 0%,
          rgba(120,255,200,0.35) 35%,
          rgba(120,255,200,0.18) 55%,
          rgba(120,255,200,0.07) 65%,
          transparent 72%
        )
      `;
    } else if (pl < 0) {
      /* RED */
      halo = `
        radial-gradient(
          circle,
          rgba(255,100,100,0.55) 0%,
          rgba(255,100,100,0.35) 35%,
          rgba(255,100,100,0.18) 55%,
          rgba(255,100,100,0.07) 65%,
          transparent 72%
        )
      `;
    } else {
      /* GREY */
      halo = `
        radial-gradient(
          circle,
          rgba(190,190,190,0.45) 0%,
          rgba(190,190,190,0.30) 35%,
          rgba(190,190,190,0.16) 55%,
          rgba(190,190,190,0.06) 65%,
          transparent 72%
        )
      `;
    }

    clock.style.setProperty("--halo", halo);
    clock.style.setProperty("--halo-bg", halo);
    clock.querySelector("::after");

    clock.style.setProperty("--halo", halo);
    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--dummy", Math.random()); // force repaint

    clock.style.setProperty("--halo", halo);
    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);
    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);
    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);
    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo", halo);
    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);
    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);
    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);
    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    clock.style.setProperty("--halo", halo);

    clock.style.setProperty("--halo-bg", halo);

    localStorage.setItem("clockVisual", JSON.stringify({ halo }));

  } catch {
    /* offline → keep last state */
  }
}

/* UPDATE HANDS */
function updateClock() {
  const now = new Date();
  const hDeg = getMonthProgressAngle();
  const mDeg = now.getMinutes() * 6 - 90;
  const sDeg = now.getSeconds() * 6 - 90;

  hourHand.style.transform = `rotate(${hDeg}deg)`;
  minuteHand.style.transform = `rotate(${mDeg}deg)`;
  secondHand.style.transform = `rotate(${sDeg}deg)`;

  localStorage.setItem(
    "clockAngles",
    JSON.stringify({ h: hDeg, m: mDeg, s: sDeg })
  );
}

updateClock();
applyMonthlyState();

setInterval(updateClock, 1000);
setInterval(applyMonthlyState, 10 * 1000);
</script>

</body>
</html>
