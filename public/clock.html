<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Monthly Discipline Clock</title>

<style>
html, body {
  margin: 0;
  background: #000;
}

/* wrapper */
.safe-zone {
  width: 260px;
  height: 260px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* CLOCK BODY */
.clock {
  position: relative;
  width: 200px;
  height: 200px;
  border-radius: 50%;

  background: #555;
  border: 6px solid #555;

  box-shadow:
    0 0 50px #555,
    inset 0 0 25px rgba(0,0,0,0.7);

  transition: background-color 0.4s linear,
              border-color 0.4s linear,
              box-shadow 0.4s linear;
}

/* markers */
.marker {
  position: absolute;
  width: 4px;
  height: 14px;
  background: #000;
  top: 10px;
  left: 50%;
  transform-origin: center 90px;
}

/* hands */
.hand {
  position: absolute;
  top: 50%;
  left: 50%;
  transform-origin: 0% 50%;
}

.hour {
  width: 35%;
  height: 6px;
  background: #000;
}

.minute {
  width: 45%;
  height: 3px;
  background: #111;
}

.second {
  width: 48%;
  height: 2px;
  background: #111;
}

/* center */
.center-dot {
  position: absolute;
  width: 10px;
  height: 10px;
  background: #000;
  border-radius: 50%;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}
</style>
</head>

<body>

<div class="safe-zone">
  <div class="clock" id="clock">

    <!-- hour markers -->
    <script>
      for (let i = 0; i < 12; i++) {
        document.write(
          `<div class="marker" style="transform: rotate(${i * 30}deg)"></div>`
        );
      }
    </script>

    <!-- hands -->
    <div class="hand hour" id="hour"></div>
    <div class="hand minute" id="minute"></div>
    <div class="hand second" id="second"></div>

    <div class="center-dot"></div>
  </div>
</div>

<script>
const clock = document.getElementById("clock");
const hourHand = document.getElementById("hour");
const minuteHand = document.getElementById("minute");
const secondHand = document.getElementById("second");

/* freeze minute & second */
minuteHand.style.transform = "rotate(0deg)";
secondHand.style.transform = "rotate(0deg)";

/* MONTH PROGRESS */
function updateMonthHand() {
  const now = new Date();
  const daysInMonth = new Date(
    now.getFullYear(),
    now.getMonth() + 1,
    0
  ).getDate();

  const progress = now.getDate() / daysInMonth;
  const angle = progress * 360 - 90;

  hourHand.style.transform = `rotate(${angle}deg)`;
}

/* ENGINE â†’ COLOR (INLINE, NO CSS VARS) */
async function applyMonthlyState() {
  try {
    const res = await fetch("/api/engine?t=" + Date.now());
    const data = await res.json();

    const pl = data.monthly.pl;

    let color;

    if (pl > 0) {
      color = "#00ff88";   // GREEN
    } else if (pl < 0) {
      color = "#ff3b3b";   // RED
    } else {
      color = "#999999";   // GREY
    }

    clock.style.backgroundColor = color;
    clock.style.borderColor = color;
    clock.style.boxShadow = `
      0 0 60px ${color},
      inset 0 0 30px rgba(0,0,0,0.7)
    `;

  } catch (e) {
    clock.style.backgroundColor = "#000";
    clock.style.borderColor = "#000";
  }
}

/* INIT */
updateMonthHand();
applyMonthlyState();

/* REFRESH */
setInterval(updateMonthHand, 60 * 60 * 1000); // hourly
setInterval(applyMonthlyState, 10 * 1000);    // every 10s
</script>

</body>
</html>
